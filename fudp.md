# Протокол обновления прошивки модулей системы БЛОК по линии связи (CAN)
Версия 8

Протокол предназначен для внутрисистемного (без отчуждения) программирования модулей системы БЛОК по CAN-линии. Протокол должен соответствовать следующим требованиям:
1.	Обеспечивать возможность программирования модуля по линии CAN без отключения его от системы
2.	Обеспечивать надёжность доставки прошивки до модуля (исключать потерю и повреждение пакетов, обеспечивать повторную посылку данных при потере)
3.	Обеспечивать возможность доставки бинарной прошивки для модулей без ОС и прошивки, представляющей набор программных файлов, для модулей с ОС
4.	Обеспечить возможность проверки версии и целостности текущей прошивки в модуле
5.	Исключить возможность прошивки модуля неродным ПО
6.	Обеспечивать возможность передачи информации о параметрах модуля, прошивки и загрузчика


## Термины и определения

_Ячейка_ – аппаратный узел системы. В случае если система состоит из нескольких полукомплектов (каналов), каждый полукомплект (канал) считается отдельной ячейкой.

_Модуль_  – функционально обособленный логический узел в системе. В одной ячейке может содержаться несколько программных модулей. Каждый модуль обладает своим идентификатором (номером), уникальным в пределах ячейки.

_Прошивка (firmware)_ – программное обеспечение модуля. Может быть представлено как один бинарный исполняемый файл (для модулей без ОС), так и как каталог с файлами и подкаталогами (для модулей с ОС).

_Программатор_ – программа, осуществляющая обновления прошивки в модуле.

_Загрузчик_ – программа, исполняемая в модуле помимо основной прошивки, или функционально обособленная часть прошивки, отвечающая за реализацию данного протокола.


## OSI-модель протокола

Протокол прошивки состоит из нескольких уровней, согласно модели OSI, расположить которые можно следующим образом:

| Слой в модели OSI	| Протокол             |
|-------------------|----------------------|
| 5. Данные	        | Протокол FUDP        |
| 4. Транспортный   | ISO-TP (ISO 15765-2) |
| 3. Сетевой	    |                      |
| 2. Канальный	    | CAN                  |
| 1. Физический	    | ---                  |

## FUDP over CAN
### CAN-сообщение
| Дескриптор | Название | Назначение
|------------|----------|--------------------------------------------------
| 66A8       | FU_INIT  | Запрос на перевод модуля в режим программирования
| 66C8       | FU_PROG  | ISO-TP сообщения, посылаемые программатором
| 66E8       | FU_DEV   | ISO-TP сообщения, посылаемые загрузчиком

### ISO-TP
Для организации возможности передачи информации длиной более 8 байт и контроля потока поверх CAN используется протокол транспортного уровня ISO 15765-2 (ISO-TP). Применяется выравнивание CAN-фрейма до 8 байт.

## Протокол FUDP (Firmware Update and Diagnostic Protocol)
Протокол FUDP работает поверх протокола ISO-TP.

Программатор является ведущим: он начинает обмен с отправки команды и дожидается ответа от загрузчика. Если через 2 секунды с момента окончания передачи команды не начато получение регламентируемого протоколом ответа, то программатор посылает команду на завершение сеанса программирования и начинает переход в новый сеанс. После 10 неудачных сеансов программирование считается не выполненным.

### Формат пакета FUDP
Пакет протокола FUDP состоит из заголовка и данных. Заголовком является первый байт ISO-TP сообщения. Он содержит  идентификатор сообщения, определяющий тип сообщения. Остальные байты – данные сообщения, специфичные для каждого типа.

| Длина |Содержимое
|:-----:|-------------------------
| 1     | идентификатор сообщения
| N     | данные сообщения

### Переход в режим программирования
Для перевода модуля в режим программирования, программатор отправляет сообщение `PROG_INIT` (идентификатор протокола FUDP: `01h`).

#### Сообщение PROG_INIT (`01h`)
Сообщение передаётся для перевода соответствующего модуля в режим программирования.

| Длина   | Содержимое
|---------|--------------------------
| 1	      | идентификатор сообщения PROG_ INIT  (01h)
| 1,5     | ID ячейки (старшим вперёд)
| 0,5     | Модификация
| 1       |	Номер программного модуля
| 0,5     | Номер канала
| 2,5     | Серийный номер (старшим вперёд)

При получении такого сообщения со значениями параметров, равными параметрам модуля, прошивка модуля должна закончить работу и передать управление загрузчику.

«0» в значении любого из параметров значит «любой». При этом, если остальные параметры равны параметрам модуля, пошивка не завершает работу, а отправляет  ответное сообщение со своими параметрами. Формат ответного сообщения совпадает с сообщением `PROG_INIT`.

#### Ответ на широковещательный запрос активных модулей – сообщение PROG_BCAST_RESPONSE (`00h`)

Сообщение предаётся на запрос `PROG_INIT`, содержащий в качестве некоторых параметров «0», при условии, что остальные параметры совпадают с параметрами модуля.

| Длина | Содержимое
|:-----:|----------------------------------------------------
| 1     | идентификатор сообщения PROG_ BCAST_RESPONSE  (00h)
| 1,5   | ID ячейки (старшим вперёд)
| 0,5   | Модификация
| 1	    | Номер программного модуля
| 0,5   | Номер канала
| 2,5   | Серийный номер (старшим вперёд)

### Инициализация соединения

После завершения работы прошивки (или при загрузке после включения питания модуля) загрузчик принимает управление на 500 мс и ожидает получения от программатора `PROG_INIT` сообщения со всеми заполненными параметрами, равными параметрам модуля. Программатор передаёт сообщение `PROG_INIT` с интервалом в 100 мс. Если в течение 500 мс сообщение PROG_INIT загрузчиком не получено, то происходит проверка целостности прошивки и её загрузка.

#### Сообщение PROG_STATUS (`02h`)

После получения сообщения `PROG_INIT` загрузчик отправляет программатору сообщение `PROG_STATUS` (идентификатор `02h`), содержащее набор значений словарных свойств. Т.е. пар ключ – значение: 1 байт на ключ и 4 байта на значение. Длина сообщения `PROG_STATUS` определяется количество заданных свойств. Максимальное количество одновременно используемых свойств = 64. Подробнее об словаре свойств смотри ниже.

Факт получения программирующим устройством сообщения `PROG_STATUS` считается началом соединения.

### Запрос списка файлов

#### Сообщение запроса списка файлов PROG_LIST_RQ (`03h`)
Для запроса списка файлов на программируемом модуле, программатор отправляет сообщение `PROG_LIST_RQ`. В случае, если список всех файлов модуля оказывается слишком длинным и не помещается в ответном сообщении, есть возможность запросить часть списка.

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_LIST_RQ (03H)
| 2     | Offset – кол-во файлов, которые необходимо пропустить с начала списка
| 2     | Count – запрашиваемое кол-во файлов (0 – все оставшиеся)

#### Сообщение списка файлов PROG_LIST (`04h`)
На запрос списка файлов загрузчик отвечает сообщением содержащим список файлов. В случае отсутствия файловой системы на программируемом устройстве, именем файла является адрес начала файла в памяти (в шестнадцатеричном виде).

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_LIST (04h)
| 1     | Длина имени  файла 1
| N     | Имя файла 1 в кодировке Win-1251
| 4     | Размер файла 1 (байт)
| 4     | Контрольная сумма файла 1
| 1     | Длина имени файла 2
| …     | …

В случае, если информация о всех имеющихся файлах не помещается в одном сообщение низлежащего уровня, то в качестве последнего файла передаётся флаг:

| Длина | Содержимое
|:-----:|-----------------------
| 1     | 0 (вместо длины имени файла)
| 4     | Кол-во файлов, не вошедших в отправленный список (вместо размера файла)
| 4     | 0 (вместо контрольной суммы)

### Чтение файла
#### Запрос на чтение – сообщение PROG_READ_RQ (`05h`)
Программатор может запросить чтение заданной части любого файла из перечисленных в `PROG_LIST`. Для этого отправляется сообщение `PROG_READ_RQ` (`05h`).

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_ READ_RQ (05h)
| 1     | Длина имени  файла
| N     | Имя файла в кодировке Win-1251
| 4     | Смещение от начала файла (байт)
| 4     | Размер считываемого блока (байт): [0 – 4000?]

#### Чтение данных – сообщение PROG_READ (`06h`)
На сообщение `PROG_READ_RQ` загрузчик отвечает сообщением `PROG_READ`.

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_ READ (06h)
| 1     | Код ошибки:
|       |   0 – Чтение успешно
|       |   1 – Файл не найден
|       |   2 – Недопустимое смещение (выходит за границу файла)
|       |   3 – Ошибка чтения
| N     | Считанные данные. (N – запрошенный размер или размер оставшейся части файла)

### Удаление файла
#### Команда на удаления файла – сообщение PROG_RM (`07h`)
Для удаления файла и очистки занимаемой им области памяти программатор отправляет сообщение PROG_RM (07h)

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_ RM (07h)
| 1     | Длина имени  файла
| N     | Имя файла в кодировке Win-1251

#### Подтверждение удаления файла – сообщение PROG_RM_ACK (`08h`)
На запрос RPOG_RM загрузчик должно ответить сообщением PROG_RM_ACK.

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_ RM (08h)
| 1     | Код ошибки:
|       |  0 – Удаление успешно
|       |  1 – Файл не существует
|       |  2 – Ошибка удаления файла

#### Команда на очистку памяти – сообщение PROG_MR_PROPER (`0Dh`)

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_MR_PROPER (0Dh)
| 4     | Шифр безопасности (4E8A1439)

#### Подтверждение очистки памяти – сообщение PROG_MR_PROPER_ACK (`0Eh`)

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_MR_PROPER _ACK (0Eh)

### Создание файла
#### Команда на создание файла – сообщение PROG_CREATE (09h)
Перед началом записи в файл, файл нужно создать.

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_ CREATE (09h)
| 1     | Длина имени файла N
| N     | Имя файла в кодировке Win-1251 (или адрес начала файла для устройств без ОС)
| 4     | Размер файла

#### Подтверждение создания файла – сообщение PROG_CREATE_ACK (0Ah)

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_ CREATE_ACK (0Ah)
| 1     | Код ошибки:
|       |  0 – Файл создан успешно
|       |  1 – Файл с таким именем уже существует
|       |  2 – Превышено максимальное количество файлов
|       |  3 – Недостаточно памяти
|       |  4 – Ошибка создания

### Запись в файл
####Команда на запись в файл – сообщение PROG_WRITE (0Bh)
Запись может вестись только в существующий файл.

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_WRITE  (0Bh)
| 1     | Длина имени файла N
| N     | Имя файла в кодировке Win-1251 (или адрес начала файла для устройств без ОС)
| 4     | Смещение от начала файла (байт)

#### Подтверждение записи в файл – сообщение PROG_WRITE_ACK (0Сh)

| Длина | Содержимое
|:-----:|-----------------------
| 1     | идентификатор сообщения PROG_WRITE_ACK (0СH)
| 1     | Код ошибки:
|       |  0 – Запись осуществлена успешно
|       |  1 – Выход за пределы записываемого файла
|       |  255 – Неизвестная ошибка

## Словарь свойств
Загрузчик отвечает за хранение в модуле списка свойств, слогласно нижеизлагаемому словарю.

Свойства делятся на 3 категории:
 * общие свойства – доступны для записи и задаются программирующим устройством.
 * постоянные свойства блока – задаются единожды при прошивке модуля на заводе. Содержат идентификацию блока.
 * свойства загрузчика – генерируются загрузчиком и описывают его версию и возможности.

| Ключ | Свойство
|-----:|----------------------------------------
|      | _Общие свойства (0 – 127)_
| 1    | Версия
| 2    | Подверсия
| 3    | Дата последнего обновления ПО
| 4    | Доработка (версия)
| 5    | Дата доработки
| 6    | Контрольная сумма прошивки целиком
| 7    | Текстовая метка версии
|      |
|      | _Постоянные свойства блока (128 – 191)_
| 129  | ID ячейки
| 130  | Номер программного модуля
| 131  | Серийный номер блока
| 132  | Дата производства (год*100 + месяц)
| 133  | Номер канала (полукомплекта): 1, 2, 3, …
| 134  | Модификация ячейки
|      |
|      | _Свойства загрузчика (192 – 255)_
| 192  | Вид
| 193  | Версия загрузчика
| 194  | Наличие файловой системы (0 – без ФС, 1 – с ФС)
| 195  | Версия протокола, по которой работает загрузчик
| 196  | Наиболее старая версия протокола, которую поддерживает загрузчик
| 197  | Подверсия загрузчика
